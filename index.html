<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web App Availability Status</title>
    <style>
        body {
            background-color: #3498db;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            color: white;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px 5px;
        }
        .watermark {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
            pointer-events: none; /* Prevent interaction with the watermark */
            user-select: none; /* Prevent text selection on the watermark */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Sentinel</h1>
        <p>Enter your web app URL:</p>
        <input type="text" id="webAppUrl" placeholder="https://your-web-app.com">
        <p>Enter status check interval (minutes):</p>
        <input type="number" id="intervalInput" placeholder="1">
        <button id="checkStatusBtn">Check Status</button>
        <button id="stopStatusBtn">Stop</button>
        <p id="status">Status will be displayed here</p>
        <p id="averageAvailability">Average Availability: N/A</p>
        <p id="availabilitySince">Availability calculated since: N/A</p>
        <p class="created-by">Created by Siva Saketh Vajramshetty</p>
        <p class="watermark">Sentinel Saketh</p>
    </div>

    <script>
    // Request notification permission
    if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission();
    }
        const statusElement = document.getElementById('status');
        const averageAvailabilityElement = document.getElementById('averageAvailability');
        const availabilitySinceElement = document.getElementById('availabilitySince');
        const webAppUrlInput = document.getElementById('webAppUrl');
        const checkStatusBtn = document.getElementById('checkStatusBtn');
        const stopStatusBtn = document.getElementById('stopStatusBtn');
        const intervalInput = document.getElementById('intervalInput');

        let intervalId;
        let totalOnlineRuns = 0;
        let totalRuns = 0;
        let availabilitySinceTime = null;

        checkStatusBtn.addEventListener('click', startStatusCheck);
        stopStatusBtn.addEventListener('click', stopStatusCheck);

        function startStatusCheck() {
            const webAppUrl = webAppUrlInput.value;
            const intervalMinutes = parseInt(intervalInput.value);

            if (isNaN(intervalMinutes) || intervalMinutes <= 0) {
                statusElement.textContent = 'Please enter a valid interval';
                return;
            }

            const intervalMilliseconds = intervalMinutes * 60000;

            if (!availabilitySinceTime) {
                availabilitySinceTime = new Date();
                updateAvailabilitySince();
            }

            getStatus(webAppUrl);
            intervalId = setInterval(() => {
                getStatus(webAppUrl);
            }, intervalMilliseconds);
        }

        function stopStatusCheck() {
            clearInterval(intervalId);
            statusElement.textContent = 'Status updates stopped';
        }

        function updateAvailabilitySince() {
            if (availabilitySinceTime) {
                const formattedTime = moment(availabilitySinceTime).format('DD MMMM, YYYY HH:mm:ss');
                availabilitySinceElement.textContent = `Availability calculated since: ${formattedTime}`;
            }
        }

        async function getStatus(webAppUrl) {
            try {
                // Use the proxy URL for making requests to external APIs
                const proxyUrl = '/api/proxy?url=' + encodeURIComponent(webAppUrl);
                const startTime = performance.now();
                const response = await fetch(proxyUrl);
                const endTime = performance.now();
                const status = response.ok ? 'Online' : 'Offline';
                const responseTime = endTime - startTime;

                if (response.ok) {
                    totalOnlineRuns++;
                }
                totalRuns++;

                const availabilityPercentage = (totalOnlineRuns / totalRuns) * 100;
                const averageAvailabilityText = isNaN(availabilityPercentage)
                    ? 'Average Availability: N/A'
                    : `Average Availability: ${availabilityPercentage.toFixed(2)}%`;

                averageAvailabilityElement.textContent = averageAvailabilityText;

                if (response.ok) {
                    statusElement.textContent = `Status: ${status} (Response time: ${responseTime.toFixed(2)} ms)`;
                } else {
                    statusElement.textContent = `Status: ${status} (Error: ${response.status} - ${response.statusText})`;
                }
            } catch (error) {
                statusElement.textContent = 'Error fetching status';
                console.error('Error fetching status:', error);
// Show a notification on error
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('Status Update Error', {
                    body: 'There was an error fetching the status. Check the console for details.',
                    icon: '/node_modules/error.png' // Replace with the path to your notification icon
                });
            }
        }
        }

    </script>
</body>
</html>